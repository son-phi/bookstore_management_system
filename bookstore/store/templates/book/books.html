{% extends "base.html" %}
{% block title %}Books{% endblock %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="m-0">Books</h3>

  <form class="d-flex gap-2" method="get" action="/books/" id="filterForm">
    <input class="form-control" name="q" value="{{ q }}" placeholder="Search title / isbn / author">
    <input type="hidden" name="category" id="categoryInput" value="{{ selected_category.categoryID|default:'' }}">

    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
        {% if selected_category %}{{ selected_category.name }}{% else %}Category{% endif %}
      </button>
      <ul class="dropdown-menu">
        <li>
          <button type="button" class="dropdown-item {% if not selected_category %}active{% endif %}" 
                  onclick="selectCategory('')">
            All Categories
          </button>
        </li>
        {% for c in categories %}
          <li>
            <button type="button" class="dropdown-item {% if c.categoryID == selected_category.categoryID %}active{% endif %}" 
                    onclick="selectCategory('{{ c.categoryID }}')">
              {{ c.name }}
            </button>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
        Select Tags
      </button>
      <ul class="dropdown-menu p-3" style="min-width: 200px;">
        {% for t in tags %}
          <li class="form-check">
            <input class="form-check-input" type="checkbox" name="tag" value="{{ t.tagID }}" id="tag{{ t.tagID }}"
              {% if t.tagID|stringformat:"s" in selected_tags_ids %}checked{% endif %}>
            <label class="form-check-label" for="tag{{ t.tagID }}">
              {{ t.name }}
            </label>
          </li>
        {% endfor %}
      </ul>
    </div>

    <button class="btn btn-outline-dark">Apply</button>
    <a class="btn btn-link" href="/books/">Clear</a>
  </form>
</div>

<div class="mb-3 d-flex align-items-center justify-content-between p-2 bg-white rounded border">
  <div>
    <strong>Found:</strong> {{ books.count }} book(s)
    
    {% if selected_category %}
      <span class="mx-2">|</span>
      Category: <span class="badge bg-info text-dark">{{ selected_category.name }}</span>
    {% endif %}

    {% if selected_tags_ids %}
      <span class="mx-2">|</span>
      Tags: 
      {% for t in tags %}
        {% if t.tagID|stringformat:"s" in selected_tags_ids %}
          <span class="badge bg-primary">{{ t.name }}</span>
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if q %}
      <span class="mx-2">|</span>
      Search: "<b>{{ q }}</b>"
    {% endif %}
  </div>
</div>

<table class="table table-striped bg-white">
  <thead>
    <tr>
      <th>Title</th><th>Category</th><th>ISBN</th><th class="text-end">Price</th><th class="text-end">Stock</th><th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for b in books %}
    <tr>
      <td>{{ b.title }}</td>
      <td>
        {% if b.categoryID %}
          <span class="badge bg-light text-dark border">{{ b.categoryID.name }}</span>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>{{ b.isbn }}</td>
      <td class="text-end">{{ b.price }}</td>
      <td class="text-end">{{ b.stock }}</td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-secondary" href="/books/{{ b.bookID }}/">View</a>

        <form method="post" action="/cart/add/{{ b.bookID }}/" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-sm btn-primary" {% if b.stock <= 0 %}disabled{% endif %}>Add</button>
        </form>

        <form method="post" action="/wishlist/add/{{ b.bookID }}/" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-dark">Wish</button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6" class="text-center text-muted">No books</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
  function selectCategory(id) {
    document.getElementById('categoryInput').value = id;
    document.getElementById('filterForm').submit();
  }
</script>
{% endblock %}
